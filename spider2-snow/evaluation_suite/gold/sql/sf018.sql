WITH all_events AS (
  -- SEND events
  SELECT 
    "APP_GROUP_ID",
    "CAMPAIGN_ID",
    "USER_ID",
    COALESCE("MESSAGE_VARIATION_ID", "MESSAGE_VARIATION_API_ID") AS "MESSAGE_VARIATION_ID_USED",
    "PLATFORM",
    "AD_TRACKING_ENABLED",
    NULL AS "CARRIER",
    NULL AS "BROWSER",
    NULL AS "DEVICE_MODEL",
    'send' AS event_type
  FROM BRAZE_USER_EVENT_DEMO_DATASET.PUBLIC.USERS_MESSAGES_PUSHNOTIFICATION_SEND_VIEW
  WHERE "TIME" BETWEEN 1685606400 AND 1685610000
  
  UNION ALL
  
  -- BOUNCE events
  SELECT 
    "APP_GROUP_ID",
    "CAMPAIGN_ID",
    "USER_ID",
    COALESCE("MESSAGE_VARIATION_ID", "MESSAGE_VARIATION_API_ID") AS "MESSAGE_VARIATION_ID_USED",
    "PLATFORM",
    "AD_TRACKING_ENABLED",
    NULL AS "CARRIER",
    NULL AS "BROWSER",
    NULL AS "DEVICE_MODEL",
    'bounce' AS event_type
  FROM BRAZE_USER_EVENT_DEMO_DATASET.PUBLIC.USERS_MESSAGES_PUSHNOTIFICATION_BOUNCE_VIEW
  WHERE "TIME" BETWEEN 1685606400 AND 1685610000
  
  UNION ALL
  
  -- OPEN events
  SELECT 
    "APP_GROUP_ID",
    "CAMPAIGN_ID",
    "USER_ID",
    COALESCE("MESSAGE_VARIATION_ID", "MESSAGE_VARIATION_API_ID") AS "MESSAGE_VARIATION_ID_USED",
    "PLATFORM",
    "AD_TRACKING_ENABLED",
    "CARRIER",
    "BROWSER",
    "DEVICE_MODEL",
    'open' AS event_type
  FROM BRAZE_USER_EVENT_DEMO_DATASET.PUBLIC.USERS_MESSAGES_PUSHNOTIFICATION_OPEN_VIEW
  WHERE "TIME" BETWEEN 1685606400 AND 1685610000
  
  UNION ALL
  
  -- INFLUENCEDOPEN events
  SELECT 
    "APP_GROUP_ID",
    "CAMPAIGN_ID",
    "USER_ID",
    COALESCE("MESSAGE_VARIATION_ID", "MESSAGE_VARIATION_API_ID") AS "MESSAGE_VARIATION_ID_USED",
    "PLATFORM",
    NULL AS "AD_TRACKING_ENABLED",
    "CARRIER",
    "BROWSER",
    "DEVICE_MODEL",
    'influenced_open' AS event_type
  FROM BRAZE_USER_EVENT_DEMO_DATASET.PUBLIC.USERS_MESSAGES_PUSHNOTIFICATION_INFLUENCEDOPEN_VIEW
  WHERE "TIME" BETWEEN 1685606400 AND 1685610000
)

SELECT 
  "APP_GROUP_ID",
  "CAMPAIGN_ID",
  "USER_ID",
  "MESSAGE_VARIATION_ID_USED" AS "MESSAGE_VARIATION_ID",
  "PLATFORM",
  "AD_TRACKING_ENABLED",
  "CARRIER",
  "BROWSER",
  "DEVICE_MODEL",
  SUM(CASE WHEN event_type = 'send' THEN 1 ELSE 0 END) AS "push_notification_sends",
  COUNT(DISTINCT CASE WHEN event_type = 'send' THEN "USER_ID" ELSE NULL END) AS "unique_push_notification_sends",
  SUM(CASE WHEN event_type = 'bounce' THEN 1 ELSE 0 END) AS "push_notification_bounced",
  COUNT(DISTINCT CASE WHEN event_type = 'bounce' THEN "USER_ID" ELSE NULL END) AS "unique_push_notification_bounced",
  SUM(CASE WHEN event_type = 'open' THEN 1 ELSE 0 END) AS "push_notification_open",
  COUNT(DISTINCT CASE WHEN event_type = 'open' THEN "USER_ID" ELSE NULL END) AS "unique_push_notification_opened",
  SUM(CASE WHEN event_type = 'influenced_open' THEN 1 ELSE 0 END) AS "push_notification_influenced_open",
  COUNT(DISTINCT CASE WHEN event_type = 'influenced_open' THEN "USER_ID" ELSE NULL END) AS "unique_push_notification_influenced_open"
FROM all_events
GROUP BY 
  "APP_GROUP_ID",
  "CAMPAIGN_ID",
  "USER_ID",
  "MESSAGE_VARIATION_ID_USED",
  "PLATFORM",
  "AD_TRACKING_ENABLED",
  "CARRIER",
  "BROWSER",
  "DEVICE_MODEL"
ORDER BY 
  "APP_GROUP_ID",
  "CAMPAIGN_ID",
  "USER_ID"
LIMIT 20