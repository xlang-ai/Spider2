WITH "FL_ZIPS" AS (
    SELECT
        "RELATED_GEO_ID" AS "ZIP_GEO_ID"
    FROM "US_ADDRESSES__POI"."CYBERSYN"."GEOGRAPHY_RELATIONSHIPS"
    WHERE "GEO_ID" = 'geoId/12'
      AND "RELATIONSHIP_TYPE" = 'Contains'
      AND "RELATED_LEVEL" = 'CensusZipCodeTabulationArea'
),
"ZIP_GEOMS" AS (
    SELECT
        f."ZIP_GEO_ID" AS "GEO_ID",
        TO_GEOGRAPHY(c."VALUE") AS "GEOM"
    FROM "FL_ZIPS" f
    JOIN "US_ADDRESSES__POI"."CYBERSYN"."GEOGRAPHY_CHARACTERISTICS" c
      ON c."GEO_ID" = f."ZIP_GEO_ID"
     AND c."RELATIONSHIP_TYPE" = 'coordinates_wkt'
     AND c."VALUE" IS NOT NULL
),
"ZIP_AREAS" AS (
    SELECT
        "GEO_ID",
        ST_AREA(ST_UNION_AGG("GEOM")) AS "AREA_M2"
    FROM "ZIP_GEOMS"
    GROUP BY "GEO_ID"
),
"LARGEST_FL_ZIP" AS (
    SELECT "GEO_ID" AS "ZIP_GEO_ID"
    FROM "ZIP_AREAS"
    ORDER BY "AREA_M2" DESC
    LIMIT 1
)
SELECT
    a."NUMBER" AS "ADDRESS_NUMBER",
    a."STREET" AS "STREET_NAME",
    a."STREET_TYPE" AS "STREET_TYPE"
FROM "US_ADDRESSES__POI"."CYBERSYN"."US_ADDRESSES" a
JOIN "LARGEST_FL_ZIP" z
  ON a."ID_ZIP" = z."ZIP_GEO_ID"
WHERE a."STATE" = 'FL'
  AND a."LATITUDE" IS NOT NULL
  AND a."NUMBER" IS NOT NULL
  AND REGEXP_LIKE(a."NUMBER", '^[0-9]+$')
  AND a."STREET" IS NOT NULL AND TRIM(a."STREET") != ''
  AND a."STREET_TYPE" IS NOT NULL AND TRIM(a."STREET_TYPE") != ''
ORDER BY a."LATITUDE" DESC, a."LONGITUDE" DESC
LIMIT 10;